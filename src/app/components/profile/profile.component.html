<app-navbar></app-navbar>

<div class="profile-container">
  <div class="profile-layout">
    <aside class="profile-sidebar">
      <div class="user-summary">
        <div class="avatar-container">
          <img [src]="profileImage" alt="Foto de Perfil" class="avatar-image">
          <label for="photo-upload" class="edit-avatar-btn" title="Alterar foto">
            <img src="/assets/icons/edit_icon.svg" alt="Edit" *ngIf="false"> <!-- Placeholder icon if needed, using emoji for now in CSS or just overlay -->
            <span>üì∑</span>
          </label>
          <input type="file" id="photo-upload" (change)="onPhotoSelected($event)" accept="image/*" hidden>
        </div>
        <h3>{{ currentUser?.name || 'Usu√°rio' }}</h3>
        <p>{{ currentUser?.email }}</p>
      </div>

      <nav class="profile-nav">
        <button 
          [class.active]="activeTab === 'personal'" 
          (click)="setActiveTab('personal')">
          Informa√ß√µes Pessoais
        </button>

        <button 
          class="orders-history-btn"
          routerLink="/orders-history">
          Hist√≥rico de Pedidos
        </button>

        <button 
          class="order-tracking-btn"
          routerLink="/order-tracking">
          Rastreamento de Pedidos
        </button>

        <button 
          [class.active]="activeTab === 'security'" 
          (click)="setActiveTab('security')">
          Login e Seguran√ßa
        </button>
        <button class="logout-btn" (click)="logout()">
          Sair
        </button>
      </nav>
    </aside>

    <main class="profile-content">
      <!-- Personal Information Section -->
      <section *ngIf="activeTab === 'personal'" class="content-section">
        <header class="section-header">
          <h2>Informa√ß√µes Pessoais</h2>
          <p>Gerencie seus dados pessoais e endere√ßo de entrega.</p>
        </header>
        
        <form [formGroup]="personalForm" (ngSubmit)="onSavePersonal()">
          <div class="form-row">
            <div class="form-group">
              <label>Nome Completo</label>
              <input type="text" formControlName="name" placeholder="Seu nome">
              <span class="error" *ngIf="personalForm.get('name')?.touched && personalForm.get('name')?.invalid">Nome √© obrigat√≥rio</span>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" formControlName="email">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>CPF</label>
              <input type="text" formControlName="cpf" placeholder="000.000.000-00">
              <span class="error" *ngIf="personalForm.get('cpf')?.touched && personalForm.get('cpf')?.invalid">CPF √© obrigat√≥rio</span>
            </div>
            <div class="form-group">
              <label>Data de Nascimento</label>
              <input type="date" formControlName="birthDate">
              <span class="error" *ngIf="personalForm.get('birthDate')?.touched && personalForm.get('birthDate')?.invalid">Data obrigat√≥ria</span>
            </div>
          </div>

          <div class="form-group">
            <label>Telefone</label>
            <input type="tel" formControlName="phone" placeholder="(00) 00000-0000">
            <span class="error" *ngIf="personalForm.get('phone')?.touched && personalForm.get('phone')?.invalid">Telefone √© obrigat√≥rio</span>
          </div>

          <div formGroupName="address" class="address-section">
            <h3>Endere√ßo</h3>
            <div class="form-group">
              <label>Rua</label>
              <input type="text" formControlName="street" placeholder="Rua, N√∫mero">
              <span class="error" *ngIf="personalForm.get('address.street')?.touched && personalForm.get('address.street')?.invalid">Rua √© obrigat√≥ria</span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Cidade</label>
                <input type="text" formControlName="city">
                <span class="error" *ngIf="personalForm.get('address.city')?.touched && personalForm.get('address.city')?.invalid">Cidade √© obrigat√≥ria</span>
              </div>
              <div class="form-group">
                <label>Estado</label>
                <input type="text" formControlName="state">
                <span class="error" *ngIf="personalForm.get('address.state')?.touched && personalForm.get('address.state')?.invalid">Estado √© obrigat√≥rio</span>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>CEP</label>
                <input type="text" formControlName="zip">
                <span class="error" *ngIf="personalForm.get('address.zip')?.touched && personalForm.get('address.zip')?.invalid">CEP √© obrigat√≥rio</span>
              </div>
              <div class="form-group">
                <label>Pa√≠s</label>
                <input type="text" formControlName="country">
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">Salvar Altera√ß√µes</button>
          </div>
        </form>
      </section>

      <!-- Security Section -->
      <section *ngIf="activeTab === 'security'" class="content-section">
        <header class="section-header">
          <h2>Login e Seguran√ßa</h2>
          <p>Gerencie sua senha e m√©todos de autentica√ß√£o.</p>
        </header>
        
        <div class="security-block">
          <h3>Alterar Senha</h3>
          <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()">
            <div class="form-group">
              <label>Senha Atual</label>
              <input type="password" formControlName="currentPassword">
              <span class="error" *ngIf="passwordForm.get('currentPassword')?.touched && passwordForm.get('currentPassword')?.invalid">Senha atual √© obrigat√≥ria</span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Nova Senha</label>
                <input type="password" formControlName="newPassword">
                <span class="error" *ngIf="passwordForm.get('newPassword')?.touched && passwordForm.get('newPassword')?.errors?.['required']">Nova senha √© obrigat√≥ria</span>
                <span class="error" *ngIf="passwordForm.get('newPassword')?.touched && passwordForm.get('newPassword')?.errors?.['minlength']">M√≠nimo 8 caracteres</span>
                <span class="error" *ngIf="passwordForm.get('newPassword')?.touched && passwordForm.get('newPassword')?.errors?.['complexity']">Requer mai√∫scula, min√∫scula e n√∫mero</span>
              </div>
              <div class="form-group">
                <label>Confirmar Nova Senha</label>
                <input type="password" formControlName="confirmPassword">
                <span class="error" *ngIf="passwordForm.errors?.['mismatch'] && passwordForm.get('confirmPassword')?.touched">Senhas n√£o conferem</span>
              </div>
            </div>
            <button type="submit" class="btn-secondary">Atualizar Senha</button>
          </form>
        </div>

        <div class="security-block">
          <h3>Autentica√ß√£o de Dois Fatores (2FA)</h3>
          <div class="toggle-row">
            <span>Ativar verifica√ß√£o em duas etapas</span>
            <label class="switch">
              <input type="checkbox" [checked]="currentUser?.twoFactorEnabled" (change)="toggleTwoFactor()">
              <span class="slider round"></span>
            </label>
          </div>
        </div>

        <div class="security-block">
          <h3>Cart√µes Cadastrados</h3>
          <div class="cards-list">
            <div *ngFor="let card of savedCards; let i = index" class="card-item">
              <div class="card-info">
                <span class="card-number">**** **** **** {{ card.number | slice:-4 }}</span>
                <span class="card-expiry">{{ card.expiry }}</span>
              </div>
              <button class="btn-icon" (click)="removeCard(i)">üóëÔ∏è</button>
            </div>
            <p *ngIf="savedCards.length === 0" class="empty-msg">Nenhum cart√£o cadastrado.</p>
          </div>

          <button *ngIf="!showCardForm" class="btn-outline" (click)="showCardForm = true">+ Adicionar Novo Cart√£o</button>

          <form *ngIf="showCardForm" [formGroup]="cardForm" (ngSubmit)="onAddCard()" class="card-form">
            <h4>Novo Cart√£o</h4>
            <div class="form-group">
              <label>N√∫mero do Cart√£o</label>
              <input type="text" formControlName="number" placeholder="0000 0000 0000 0000" maxlength="16">
               <span class="error" *ngIf="cardForm.get('number')?.touched && cardForm.get('number')?.invalid">N√∫mero inv√°lido (16 d√≠gitos)</span>
            </div>
            <div class="form-group">
              <label>Nome no Cart√£o</label>
              <input type="text" formControlName="name" placeholder="Como impresso no cart√£o">
               <span class="error" *ngIf="cardForm.get('name')?.touched && cardForm.get('name')?.invalid">Nome obrigat√≥rio</span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Validade</label>
                <input type="text" formControlName="expiry" placeholder="MM/AA" maxlength="5">
                 <span class="error" *ngIf="cardForm.get('expiry')?.touched && cardForm.get('expiry')?.invalid">Formato MM/AA</span>
              </div>
              <div class="form-group">
                <label>CVV</label>
                <input type="text" formControlName="cvv" placeholder="123" maxlength="4">
                 <span class="error" *ngIf="cardForm.get('cvv')?.touched && cardForm.get('cvv')?.invalid">3 ou 4 d√≠gitos</span>
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-text" (click)="showCardForm = false">Cancelar</button>
              <button type="submit" class="btn-primary">Salvar Cart√£o</button>
            </div>
          </form>
        </div>
      </section>
    </main>
  </div>
</div>